#!/usr/bin/env bash
# Reply to a PR comment
# Usage: bb-pr-reply PR_ID COMMENT_ID "reply text"

set -euo pipefail

: "${BITBUCKET_TOKEN:?Set BITBUCKET_TOKEN}"
: "${BITBUCKET_URL:?Set BITBUCKET_URL}"

BITBUCKET_API="$BITBUCKET_URL/rest/api/1.0"
BITBUCKET_USER="${BITBUCKET_USER:-$(git config user.email)}"

if [[ $# -lt 3 ]]; then
  echo "Usage: bb-pr-reply PR_ID COMMENT_ID \"reply text\"" >&2
  exit 1
fi

PR_ID="$1"
COMMENT_ID="$2"
REPLY_TEXT="$3"

# Detect project/repo
remote=$(git remote get-url origin)
if [[ "$remote" =~ ^ssh:// ]]; then
  PROJECT=$(echo "$remote" | sed -E 's|.*[:/]([^/]+)/[^/]+\.git$|\1|' | tr '[:lower:]' '[:upper:]')
  REPO=$(echo "$remote" | sed -E 's|.*/([^/]+)\.git$|\1|')
elif [[ "$remote" =~ ^https:// ]]; then
  PROJECT=$(echo "$remote" | sed -E 's|.*/scm/([^/]+)/.*|\1|' | tr '[:lower:]' '[:upper:]')
  REPO=$(echo "$remote" | sed -E 's|.*/([^/]+)\.git$|\1|')
else
  echo "ERROR: Unrecognized git remote format" >&2
  exit 1
fi

# Use jq to safely encode the reply text as JSON
JSON_PAYLOAD=$(jq -n --arg text "$REPLY_TEXT" '{"text": $text}')

curl -sf -u "$BITBUCKET_USER:$BITBUCKET_TOKEN" \
  -X POST \
  "$BITBUCKET_API/projects/$PROJECT/repos/$REPO/pull-requests/$PR_ID/comments/$COMMENT_ID/comments" \
  -H "Content-Type: application/json" \
  -d "$JSON_PAYLOAD"

echo "Replied to comment $COMMENT_ID on PR #$PR_ID"
